# Advanced Cognitive Modelling (ACM)

This repo contains **Assignment 1** for the ACM course: a **Matching Pennies** tournament where each strategy’s behaviour is **parameterised via Stan** (parameters drawn from Stan priors), and one behavioural model is **fit in Stan** to simulated sequences.

Core design choices:
- **Stan-only strategies**: even the “random” baseline draws its randomness parameter from a **Stan prior** (no fixed `p=0.5` strategy).
- Minimal “high-grade-signal” figure set:
  1) **Matchup bars with uncertainty intervals**
  2) **Role-swap swing** (vertical marker at trial 30; block totals 1–30 vs 31–60)
  3) **Stan posterior parameter plot**
  4) *(optional)* **Payoff distribution**

---

## Repo structure

```
.
├─ assignment1.qmd          # Quarto report (renders figures + interpretation)
├─ run_all.R                # One-click pipeline runner
├─ R/
│  ├─ game.R                # Matching pennies game simulator (role swap at trial 30)
│  ├─ strategies.R          # Strategy definitions (StanRandom, WSLS(Stan), k-ToM(Stan))
│  ├─ tournament.R          # Tournament runner + summaries
│  ├─ plotting.R            # The 3–4 required plots
│  ├─ stan_priors.R         # Draw parameters from Stan priors (cmdstanr)
│  ├─ stan_fit.R            # Fit Stan policy model & summarise posterior
│  └─ utils.R               # Small helpers
├─ stan/
│  ├─ prior_random.stan     # Prior for StanRandom baseline
│  ├─ prior_wsls.stan       # Prior for WSLS parameters
│  ├─ prior_ktom.stan       # Prior for k-ToM parameters
│  └─ wsls_policy.stan      # Stan likelihood model fit to sequences
├─ data/
│  └─ processed/            # Saved tournament outputs (CSV)
└─ figs/                    # Saved figures (PNG)
```

---

## Requirements

R packages (minimum):
- `cmdstanr`
- `posterior`
- `bayesplot`
- `tidyverse` (or at least `dplyr`, `readr`, `ggplot2`)
- `quarto` (optional, only needed to render `assignment1.qmd`)

Install packages:
```r
install.packages(c(
  "cmdstanr", "posterior", "bayesplot",
  "dplyr", "readr", "ggplot2", "tidyr", "purrr",
  "quarto"
))
```

CmdStan:
```r
cmdstanr::install_cmdstan()
cmdstanr::check_cmdstan_toolchain(fix = TRUE)
```

---

## Quickstart (recommended)

1) Open the project folder in RStudio.
2) Run the full pipeline:
```r
source("run_all.R")
```

This will:
- draw Stan prior parameters for each strategy,
- run the tournament,
- write CSV outputs to `data/processed/`,
- write figures to `figs/`,
- fit the Stan policy model and save posterior summaries,
- optionally render the Quarto report if Quarto is available.

---

## Render the report (Quarto)

If you want a single compiled report:

```r
quarto::quarto_render("assignment1.qmd")
```

Output appears next to the `.qmd` (HTML/PDF depending on your YAML settings).

---

## Key outputs

Saved to disk by `run_all.R`:

Data:
- `data/processed/trials.csv` — trial-level outcomes
- `data/processed/summary_matchups.csv` — matchup summaries + intervals
- `data/processed/summary_blocks.csv` — block totals (1–30 vs 31–60) per matchup

Figures:
- `figs/matchup_bars_intervals.png` — **Figure 1**
- `figs/role_swap_swing.png` — **Figure 2**
- `figs/stan_posterior_params.png` — **Figure 3**
- `figs/payoff_distribution.png` — **Figure 4 (optional)**

---

## Notes on the modelling choices

- **WSLS(Stan)**: behaviour is generated by sampling `(p_repeat_win, p_repeat_loss, lapse)` from `stan/prior_wsls.stan` for each spawned agent.
- **k-ToM(Stan)**: behaviour is generated by sampling ToM parameters (learning/softmax/mixture) from `stan/prior_ktom.stan`.
- **Stan policy fit**: `stan/wsls_policy.stan` is fit to sequences (typically against the StanRandom baseline) to show that inference can recover a WSLS-like signature.

---

## Troubleshooting (Windows + cmdstanr)

1) “cannot write PCH file: required memory segment unavailable”
- Disable precompiled headers and rebuild CmdStan:
```r
cmdstanr::write_stan_make_local(list(PRECOMPILED_HEADERS = "false"))
cmdstanr::rebuild_cmdstan()
```

2) Intel TBB path note
- If you see a message about adding a TBB folder to PATH, the simplest fix is usually:
  - restart R/RStudio after `cmdstanr::rebuild_cmdstan()`
  - (optional) re-run `cmdstanr::check_cmdstan_toolchain(fix=TRUE)`

3) Stan array syntax errors
- This repo uses **new Stan array syntax** (e.g., `array[N, T] int choice;`). If you copy/paste older code, update the syntax.

---

## Reproducibility knobs

In `run_all.R` you can change:
- `n_sims` (number of simulated matches per matchup)
- `n_block` (role-swap block size; default 30 gives trials 1–30 and 31–60)
- random seeds for draws/simulation/fitting

---

## Contact / context

This repo is formatted to be simple:
- one script to run (`run_all.R`)
- outputs saved as CSV + PNG, not R objects
- report in `assignment1.qmd` is designed to be clear and modular, with comments and a simple structure. The tournament is deterministic given the drawn parameters, so you can reproduce results by setting the same seeds.
