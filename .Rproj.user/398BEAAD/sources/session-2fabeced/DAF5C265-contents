# Pipeline:
# 1) Sample Stan priors to get parameter draws for WSLS and ForgetfulBias.
# 2) Build strategy specs that spawn agents using those draws.
# 3) Run tournament and generate plots (role swap marker + block totals).
# 4) Fit a Stan policy model to sequences (A vs Random) and plot posteriors.
# 5) Render Quarto report if Quarto is available.

setwd(dirname(rstudioapi::getActiveDocumentContext()$path))

suppressPackageStartupMessages({
  library(dplyr)
  library(readr)
  library(ggplot2)
})

source(file.path("R", "stan_priors.R"))
source(file.path("R", "strategies.R"))
source(file.path("R", "game.R"))
source(file.path("R", "tournament.R"))
source(file.path("R", "plotting.R"))
source(file.path("R", "stan_fit.R"))

dir.create(file.path("data", "processed"), recursive = TRUE, showWarnings = FALSE)
dir.create("figs", showWarnings = FALSE)

# ---- 1) Stan prior draws (used by the tournament) ----
wsls_draws <- sample_prior_draws(
  stan_file = file.path("stan", "prior_wsls.stan"),
  vars = c("p_repeat_win", "p_repeat_loss", "lapse"),
  n_draws = 1000,
  seed = 1
)

bias_draws <- sample_prior_draws(
  stan_file = file.path("stan", "prior_bias.stan"),
  vars = c("eta", "lapse"),
  n_draws = 1000,
  seed = 2
)

write_csv(wsls_draws, file.path("data", "processed", "stan_prior_draws_wsls.csv"))
write_csv(bias_draws, file.path("data", "processed", "stan_prior_draws_bias.csv"))

p_prior <- plot_prior_params(wsls_draws, bias_draws)
ggsave(file.path("figs", "stan_prior_params.png"), p_prior, width = 10, height = 5, dpi = 200)

# ---- 2) Strategies (spawn agents using Stan draws) ----
strategies <- list(
  make_random(0.5),
  make_wsls_stan(wsls_draws),
  make_forgetful_bias_stan(bias_draws)
)

# ---- 3) Tournament ----
res <- run_tournament(
  strategy_specs = strategies,
  n_sims = 300,
  n_block = 30,
  seed = 3
)

write_csv(res$trials, file.path("data", "processed", "trials.csv"))
write_csv(res$summary_final, file.path("data", "processed", "summary_final.csv"))
write_csv(res$summary_blocks, file.path("data", "processed", "summary_blocks.csv"))

p_cum <- plot_mean_cum_payoff(res$trials)
ggsave(file.path("figs", "mean_cum_payoff.png"), p_cum, width = 12, height = 9, dpi = 200)

p_block <- plot_block_heatmap(res$trials, n_block = 30)
ggsave(file.path("figs", "block_heatmap.png"), p_block, width = 12, height = 6, dpi = 200)

p_heat <- plot_final_heatmap(res$summary_final)
ggsave(file.path("figs", "final_heatmap.png"), p_heat, width = 9, height = 6, dpi = 200)

p_dist <- plot_final_distribution(res$trials)
ggsave(file.path("figs", "final_distribution.png"), p_dist, width = 9, height = 6, dpi = 200)

# ---- 4) Stan fit to sequences (A vs Random) ----
random_spec <- strategies[[1]]
stan_file_fit <- file.path("stan", "wsls_policy.stan")

fit_summaries <- list()
k <- 1L

for (spec_A in strategies) {
  trials_pair <- simulate_pair(spec_A, random_spec, n_sims = 200, seed = 10)
  fit <- fit_policy_model(trials_pair, stan_file = stan_file_fit, seed = 20)
  fit_summaries[[k]] <- summarise_fit(fit, label = spec_A$name)
  k <- k + 1L
}

stan_policy_summary <- bind_rows(fit_summaries)
write_csv(stan_policy_summary, file.path("data", "processed", "stan_policy_summary.csv"))

p_stan <- plot_policy_intervals(stan_policy_summary)
ggsave(file.path("figs", "stan_policy_params.png"), p_stan, width = 10, height = 5, dpi = 200)

# ---- 5) Render report (optional) ----
if (nzchar(Sys.which("quarto"))) {
  system("quarto render assignment1.qmd", intern = FALSE)
} else {
  message("Quarto not found on PATH. Skipping render. You can still render in RStudio if Quarto is installed.")
}

message("Done. See data/processed/ and figs/.")
